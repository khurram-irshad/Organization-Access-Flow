<h1>Organizations</h1>

<!-- Only show "New Organization" to teens and adults, NOT kids -->
<% if policy(Organization).create? %>
  <p><%= link_to "New Organization", new_organization_path, class: "btn btn-primary" %></p>
<% end %>

<% if @organizations.any? %>
  <div style="margin-top: 20px;">
    <% @organizations.each do |org| %>
      <div style="border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 5px;">
        <h3><%= link_to org.name, organization_path(org) %></h3>
        <p><%= org.description %></p>
        <p><strong>Members:</strong> <%= org.users.count %></p>
        
        <!-- Show join/member status -->
        <% unless current_user.organizations.include?(org) %>
          <%= button_to "Join Organization", 
              organization_membership_path(org), 
              method: :post,
              class: "btn btn-success" %>
        <% else %>
          <p style="color: green;"><strong>âœ“ You are a member</strong></p>
          <% if current_user.has_role?(:admin, org) %>
            <p style="color: blue;"><em>Role: Administrator</em></p>
          <% elsif current_user.has_role?(:member, org) %>
            <p style="color: gray;"><em>Role: Member</em></p>
          <% end %>
          
          <!-- Show leave option for members -->
          <%= button_to "Leave Organization", 
              organization_membership_path(org), 
              method: :delete,
              data: { confirm: "Are you sure you want to leave?" },
              class: "btn btn-warning btn-sm" %>
        <% end %>
        
        <!-- ONLY show admin options if user is ADMIN of THIS specific organization -->
        <% if current_user.has_role?(:admin, org) %>
          <div style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 3px;">
            <strong>Admin Actions:</strong><br>
            <%= link_to "Edit", edit_organization_path(org), class: "btn btn-secondary btn-sm" %>
            <%= button_to "Delete", organization_path(org), 
                method: :delete, 
                data: { confirm: "Are you sure?" }, 
                class: "btn btn-danger btn-sm" %>
            <%= link_to "View Analytics", 
                organization_analytics_path(organization_id: org.id), 
                class: "btn btn-info btn-sm" %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
<% else %>
  <p>No organizations found.</p>
  <% if policy(Organization).create? %>
    <p><%= link_to "Create the first organization!", new_organization_path %></p>
  <% else %>
    <p>Please wait for organizations to be created by adults or teens.</p>
  <% end %>
<% end %>