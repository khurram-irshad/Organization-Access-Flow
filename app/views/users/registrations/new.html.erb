<h2>Sign Up</h2>
<% if @user&.errors&.any? %>
  <div style="background-color: #ffe6e6; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
    <h4 style="color: red; margin: 0 0 10px 0;">Please fix the following errors:</h4>
    <ul style="margin: 0;">
      <% @user.errors.full_messages.each do |msg| %>
        <li style="color: red;"><%= msg %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<%= form_with model: @user, url: user_registration_path, local: true do |f| %>
  <div>
    <%= f.label :email %>
    <%= f.email_field :email, required: true %>
  </div>
  
  <div>
    <%= f.label :password %>
    <%= f.password_field :password, required: true %>
  </div>
  
  <div>
    <%= f.label :password_confirmation %>
    <%= f.password_field :password_confirmation, required: true %>
  </div>
  
  <div>
    <%= f.label :first_name %>
    <%= f.text_field :first_name, required: true %>
  </div>
  
  <div>
    <%= f.label :last_name %>
    <%= f.text_field :last_name, required: true %>
  </div>
  
  <div>
    <%= f.label :date_of_birth %>
    <%= f.date_field :date_of_birth, required: true, onchange: "toggleParentEmailField()" %>
  </div>
  
  <div id="parent-email-section" style="display: none;">
    <%= f.label :parent_email, "Parent's Email (Required for users under 13)" %>
    <%= f.email_field :parent_email %>
    <small style="color: #666; display: block;">We'll send a verification email to your parent/guardian</small>
  </div>
  
  <%= f.submit "Sign Up" %>
<% end %>

<script>
function toggleParentEmailField() {
  console.log('ğŸ”„ toggleParentEmailField called');
  
  const dateInput = document.querySelector('input[type="date"]');
  const parentSection = document.getElementById('parent-email-section');
  const parentEmailInput = document.querySelector('input[name="user[parent_email]"]');
  
  console.log('ğŸ“… Date input:', dateInput);
  console.log('ğŸ“§ Parent section:', parentSection);
  console.log('ğŸ“§ Parent email input:', parentEmailInput);
  
  if (!dateInput || !parentSection || !parentEmailInput) {
    console.error('âŒ Required elements not found');
    return;
  }
  
  const dobValue = dateInput.value;
  console.log('ğŸ“… Date value:', dobValue);
  
  if (!dobValue) {
    console.log('âŒ No date selected');
    parentSection.style.display = 'none';
    parentEmailInput.required = false;
    parentEmailInput.value = '';
    return;
  }
  
  const dob = new Date(dobValue);
  const today = new Date();
  
  console.log('ğŸ“… DOB:', dob);
  console.log('ğŸ“… Today:', today);
  
  let age = today.getFullYear() - dob.getFullYear();
  
  // Adjust age if birthday hasn't occurred this year
  if (today.getMonth() < dob.getMonth() || 
      (today.getMonth() === dob.getMonth() && today.getDate() < dob.getDate())) {
    age--;
  }
  
  const isKid = age < 13;
  console.log('ğŸ§® Calculated age:', age);
  console.log('ğŸ‘¶ Is kid (under 13):', isKid);
  
  if (isKid) {
    console.log('âœ… Showing parent email field');
    parentSection.style.display = 'block';
    parentEmailInput.required = true;
  } else {
    console.log('âŒ Hiding parent email field');
    parentSection.style.display = 'none';
    parentEmailInput.required = false;
    parentEmailInput.value = '';
  }
}

// Call the function when the page loads in case there's already a date value
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸ“„ Page loaded, checking initial state');
  toggleParentEmailField();
});
</script>